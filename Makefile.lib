# SmartTerm Library Makefile
#
# Builds libsmartterm.a and examples

CC = gcc
AR = ar
CFLAGS = -Wall -Wextra -O2 -Iinclude
LDFLAGS = -lncurses -lreadline -lpthread

# Directories
LIB_DIR = lib/smartterm
INCLUDE_DIR = include
EXAMPLES_DIR = examples
TEST_DIR = tests
BUILD_DIR = build
OBJ_DIR = $(BUILD_DIR)/obj
BIN_DIR = $(BUILD_DIR)/bin
TEST_BIN_DIR = $(BUILD_DIR)/test

# Library sources
LIB_SRCS = $(wildcard $(LIB_DIR)/*.c)
LIB_OBJS = $(patsubst $(LIB_DIR)/%.c,$(OBJ_DIR)/%.o,$(LIB_SRCS))

# Library target
LIB_TARGET = $(BUILD_DIR)/libsmartterm.a

# Example sources
EXAMPLE_SRCS = $(wildcard $(EXAMPLES_DIR)/*.c)
EXAMPLE_BINS = $(patsubst $(EXAMPLES_DIR)/%.c,$(BIN_DIR)/%,$(EXAMPLE_SRCS))

# Test sources
TEST_SRCS = $(wildcard $(TEST_DIR)/test_*.c)
TEST_BINS = $(patsubst $(TEST_DIR)/%.c,$(TEST_BIN_DIR)/%,$(TEST_SRCS))

# POC executable
POC_TARGET = $(BUILD_DIR)/smartterm_poc

.PHONY: all lib examples tests test clean install format

# Default target
all: lib examples

# Create directories
$(OBJ_DIR) $(BIN_DIR) $(TEST_BIN_DIR):
	mkdir -p $@

# Build library
lib: $(LIB_TARGET)

$(LIB_TARGET): $(LIB_OBJS) | $(BUILD_DIR)
	$(AR) rcs $@ $^
	@echo "Library built: $@"

# Compile library object files
$(OBJ_DIR)/%.o: $(LIB_DIR)/%.c | $(OBJ_DIR)
	$(CC) $(CFLAGS) -c $< -o $@

# Build examples
examples: $(EXAMPLE_BINS)

$(BIN_DIR)/%: $(EXAMPLES_DIR)/%.c $(LIB_TARGET) | $(BIN_DIR)
	$(CC) $(CFLAGS) $< -L$(BUILD_DIR) -lsmartterm $(LDFLAGS) -o $@
	@echo "Built example: $@"

# Build POC
poc: $(POC_TARGET)

$(POC_TARGET): smartterm_poc.c | $(BUILD_DIR)
	$(CC) $(CFLAGS) $< $(LDFLAGS) -o $@
	@echo "Built POC: $@"

# Build tests
tests: $(TEST_BINS)

$(TEST_BIN_DIR)/%: $(TEST_DIR)/%.c $(TEST_DIR)/framework.c $(LIB_TARGET) | $(TEST_BIN_DIR)
	$(CC) $(CFLAGS) $< $(TEST_DIR)/framework.c -L$(BUILD_DIR) -lsmartterm $(LDFLAGS) -o $@
	@echo "Built test: $@"

# Run tests
test: tests
	@echo "Running tests..."
	@for test in $(TEST_BINS); do \
		echo ""; \
		echo "Running $$test..."; \
		$$test || exit 1; \
	done
	@echo ""
	@echo "All tests passed!"

# Install library (optional)
install: $(LIB_TARGET)
	@echo "Installing library..."
	install -d /usr/local/lib
	install -m 644 $(LIB_TARGET) /usr/local/lib/
	install -d /usr/local/include
	install -m 644 $(INCLUDE_DIR)/smartterm.h /usr/local/include/
	@echo "Installation complete"

# Format code
format:
	@echo "Formatting code..."
	find . -type f \( -name "*.c" -o -name "*.h" \) ! -path "./.git/*" ! -path "./build/*" -exec clang-format -i {} \;
	@echo "Formatting complete"

# Clean build artifacts
clean:
	rm -rf $(BUILD_DIR)
	@echo "Clean complete"

# Build directory
$(BUILD_DIR):
	mkdir -p $(BUILD_DIR)

# Help target
help:
	@echo "SmartTerm Library Makefile"
	@echo ""
	@echo "Targets:"
	@echo "  all       - Build library and examples (default)"
	@echo "  lib       - Build library only"
	@echo "  examples  - Build example programs"
	@echo "  tests     - Build test suite"
	@echo "  test      - Build and run all tests"
	@echo "  poc       - Build original POC"
	@echo "  format    - Format code with clang-format"
	@echo "  install   - Install library system-wide"
	@echo "  clean     - Remove build artifacts"
	@echo "  help      - Show this help"
	@echo ""
	@echo "Example usage:"
	@echo "  make lib              # Build library"
	@echo "  make examples         # Build all examples"
	@echo "  make test             # Run tests"
	@echo "  make                  # Build everything"
	@echo "  ./build/bin/repl      # Run REPL example"
